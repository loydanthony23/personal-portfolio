name: Pull Request Validation

on:
  pull_request:
    branches: [ main ]
    paths:
      - '**/*.html'
      - '**/*.css'
      - '**/*.js'
      - '**/*.php'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install validators
      run: |
        npm install -g html-validate
        npm install -g csslint
        npm install -g jshint
        
    - name: Validate HTML files
      run: |
        echo "🔍 Validating HTML files..."
        find . -name "*.html" -not -path "./assets/vendor/*" -exec html-validate {} \;
        
    - name: Validate CSS files
      run: |
        echo "🎨 Validating CSS files..."
        find . -name "*.css" -not -path "./assets/vendor/*" -exec csslint {} \; || true
        
    - name: Validate JavaScript files
      run: |
        echo "⚡ Validating JavaScript files..."
        find . -name "*.js" -not -path "./assets/vendor/*" -exec jshint {} \; || true
        
    - name: Check file sizes
      run: |
        echo "📊 Checking file sizes..."
        echo "HTML files:"
        find . -name "*.html" -exec ls -lh {} \; | awk '{print $5, $9}'
        echo "CSS files:"
        find . -name "*.css" -not -path "./assets/vendor/*" -exec ls -lh {} \; | awk '{print $5, $9}'
        echo "JS files:"
        find . -name "*.js" -not -path "./assets/vendor/*" -exec ls -lh {} \; | awk '{print $5, $9}'
        
    - name: Check for console errors
      run: |
        echo "🚨 Checking for potential console errors..."
        grep -r "console\." assets/js/ || echo "No console statements found"
        
    - name: Validate PHP files (if any)
      run: |
        echo "🐘 Validating PHP files..."
        find . -name "*.php" -exec php -l {} \;
        
    - name: Security check
      run: |
        echo "🔒 Running basic security checks..."
        # Check for potential XSS vulnerabilities
        grep -r "innerHTML\|document\.write" . --include="*.html" --include="*.js" || echo "No potential XSS found"
        
    - name: Comment PR with validation results
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '✅ **Validation Complete!**\n\nYour resume website changes have been validated. The workflow checked:\n- HTML syntax\n- CSS syntax\n- JavaScript syntax\n- File sizes\n- Basic security checks\n\nAll checks passed! 🎉'
          })
